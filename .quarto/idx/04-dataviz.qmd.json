{"title":"Data viz I","markdown":{"headingText":"Data viz I","headingAttr":{"id":"sec-dataviz","classes":[],"keyvalue":[]},"containsRefs":false,"markdown":"\n```{r include=FALSE}\nlibrary(tidyverse)\nlibrary(palmerpenguins)\nlibrary(patchwork)\nlibrary(webexercises)\n\n# Layers\n# https://intro2r.com/the-start-of-the-end.html\n```\n\n## Intended Learning Outcomes {.unnumbered}\n\nBy the end of this chapter, you should be able to:\n\n-   explain the layered grammar of graphics\n-   choose an appropriate plot for categorical variables\n-   create a basic version of an appropriate plot\n-   apply additional layers to modify the appearance of the plot\n\n\nIt is time to think about selecting the most appropriate plot for your data. Different types of variables call for different kinds of plots, which depends on how many variables you’re aiming to plot and what their data types are. In this chapter, we will focus on **plots for categorical data**. Next week, we will explore plots for continuous variables and learn which plots work best when combining continuous and categorical data.\n\n## [Individual Walkthrough]{style=\"color: #F39C12; text-transform: uppercase;\"} {.unnumbered}\n\n## Building plots {.unnumbered}\n\nWe are using the package `ggplot2` to create data visualisations. It's part of the tidyverse package. Actually, most people call th package `ggplot` but it's official name is `ggplot2`.\n\nWe’ll be using the `ggplot2` package to create data visualisations. It’s part of the `tidyverse` suite of packages. Although many people refer to it simply as `ggplot`, its official name is `ggplot2`.\n\n::: grid\n::: g-col-6\n**ggplot2** uses a layered grammar of graphics, where plots are constructed through a series of layers. You start with a base layer (by calling `ggplot`), then add **data** and **aesthetics**, followed by selecting the appropriate **geometries** for the plot.\n\nThese first 3 layers will give you the most simple version of a complete plot. However, you can enhance the plot’s clarity and appearance by adding additional layers such as **scales**, **facets**, **coordinates**, **labels** and **themes**.\n\n:::\n\n::: g-col-6\n![gg layers [(Presentation by Ryan Safner)](https://metricsf20.classes.ryansafner.com/slides/1.3-slides#20){target=\"_blank\"}](images/gglayers.png){width=\"90%\"}\n:::\n:::\n\nTo give you a brief overview of the layering system, we will use the `palmerpenguins` package ([https://allisonhorst.github.io/palmerpenguins/](https://allisonhorst.github.io/palmerpenguins/){target=\"_blank\"}). This dataset contains information about penguins, including bill length and depth, flipper length, body mass, and more.\n\n```{r}\nhead(penguins)\n```\n\nLet's build a basic scatterplot to show the relationship between `flipper_length` and `body_mass`. We will customise plots further later on in the individual plots. This is just a quick overview of the different layers.\n\nLet’s build a basic scatterplot to show the relationship between `flipper_length` and `body_mass`. We will further customise the plots in subsequent sections, but for now, this will provide a quick overview of the different layers.\n\n* **Layer 1** creates the base plot that we build upon.\n* **Layer 2** adds the `data` and some `aesthetics`:\n  * The data is passed as the first argument.\n  * Aesthetics are added via the mapping argument, where you define your variables (e.g., x or both x and y). This also allows you to specify general properties, like the color for grouping variables, etc.\n* **Layer 3** adds geometries, or `geom_?` for short. This tells ggplot how to display the data points. Remember to add these layers with a `+`, rather than using a pipe (`%>%`). You can also add multiple geoms if needed, for example, combining a violin plot with a boxplot.\n* **Layer 4** includes `scale_?` functions, which let you customise aesthetics like color. You can do much more with scales, but we'll explore later.\n* **Layer 5** introduces facets, such as `facet_wrap()`, allowing you to add an extra dimension to your plot by showing the relationship you are interested in for each level of a categorical variable.\n* **Layer 6** involves coordinates, where `coord_cartesian()` controls the limits for the x- and y-axes (xlim and ylim), enabling you to zoom in or out of the plot.\n* **Layer 7** helps you modify axis labels.\n* **Layer 8** controls the overall style of the plot, including background color, text size, and borders. R provides several predefined themes, such as `theme_classic`, `theme_bw`, `theme_minimal`, and `theme_light`.\n\nClick on the tabs below to see how each layer contributes to refining the plot.\n\n::: {.panel-tabset}\n## Layer 1\n\n```{r}\nggplot()\n```\n\nThere’s not much to see at this stage - this is basically an empty plot layer.\n\n## Layer 2\n\n```{r}\nggplot(data = penguins, mapping = aes(x = body_mass_g, y = flipper_length_mm))\n```\n\nYou won’t see any data points yet because we haven’t specified how to display them. However, we have mapped the aesthetics, indicating that we want to plot `body_mass` on the x-axis and `flipper_length` on the y-axis. This also sets the axis titles, as well as the axis values and breakpoints.\n\n::: callout-tip\nYou won't need to add `data =` or `mapping =` if you keep those arguments in exactly that order. Likewise, the first column name you enter within the `aes()` function will always be interpreted as x, and the second as y, so you could omit them if you wish.\n\nYou don’t need to include `data =` or `mapping =` if you keep those arguments in the default order. Similarly, the first column name you enter in the `aes()` function will automatically be interpreted as the x variable, and the second as y, so you can omit specifying `x` and `y` if you prefer.\n\n```{r eval = FALSE}\nggplot(penguins, aes(body_mass_g, flipper_length_mm))\n```\n\nwill give you the same output as the code above.\n:::\n\n## Layer 3\n\n```{r}\nggplot(data = penguins, mapping = aes(x = body_mass_g, y = flipper_length_mm, colour = sex)) +\n  geom_point()\n```\n\nHere we are telling `ggplot` to add a scatterplot. You may notice a warning indicating that some rows were removed due to missing values.\n\nThe `colour` argument adds colour to the points based on a grouping variable (in this case, `sex`).  If you want all the points to be black — representing only two dimensions rather than three — simply omit the `colour` argument.\n\n## Layer 4\n\n```{r}\nggplot(data = penguins, mapping = aes(x = body_mass_g, y = flipper_length_mm, colour = sex)) +\n  geom_point() +\n  # changes colour palette\n  scale_colour_brewer(palette = \"Dark2\") + \n  # add breaks from 2500 to 6500 in increasing steps of 500\n  scale_x_continuous(breaks = seq(from = 2500, to = 6500, by = 500)) \n  \n```\n\nThe `scale_?` functions allow us to modify the color palette of the plot, adjust axis breaks, and more. You could change the axis labels within `scale_x_continuous()` as well or leave it for Layer 7.\n\n## Layer 5\n\n```{r}\nggplot(data = penguins, mapping = aes(x=body_mass_g, y=flipper_length_mm, colour=sex)) +\n  geom_point() +\n  scale_colour_brewer(palette = \"Dark2\") + \n  # split main plot up into different subplots by species \n  facet_wrap(~ species) \n\n```\n\nIn this step, we’re using faceting to split the plot by species.\n\n## Layer 6\n\n```{r}\nggplot(data = penguins, mapping = aes(x=body_mass_g, y=flipper_length_mm, colour=sex)) +\n  geom_point() +\n  scale_colour_brewer(palette = \"Dark2\") + \n  facet_wrap(~ species) +\n  # limits the range of the y axis\n  coord_cartesian(ylim = c(0, 250)) \n```\n\nHere we adjust the limits of the y-axis to zoom out of the plot. If you want to zoom in or out of the x-axis, you can add the `xlim` argument to the `coord_cartesian()` function.\n\n## Layer 7\n\n```{r}\nggplot(data = penguins, mapping = aes(x=body_mass_g, y=flipper_length_mm, colour=sex)) +\n  geom_point() +\n  scale_colour_brewer(palette = \"Dark2\") + \n  facet_wrap(~ species) +\n  labs(x = \"Body Mass (in g)\", # labels the x axis\n       y = \"Flipper length (in mm)\", # labels the y axis\n       colour = \"Sex\") # labels the grouping variable in the legend\n```\n\nYou can change the axis labels using the `labs()` function, or you can modify them when adjusting the scales (e.g., within the `scale_x_continuous()` function).\n\n## Layer 8\n\n```{r}\nggplot(data = penguins, mapping = aes(x=body_mass_g, y=flipper_length_mm, colour=sex)) +\n  geom_point() +\n  scale_colour_brewer(palette = \"Dark2\") + \n  facet_wrap(~ species) +\n  labs(x = \"Body Mass (in g)\", \n       y = \"Flipper length (in mm)\",\n       colour = \"Sex\") +\n  # add a theme\n  theme_classic()\n\n```\n\nThe `theme_classic()` function is applied to change the overall appearance of the plot.\n\n:::\n\n::: callout-important\n\nYou need to stick to the first three layers to create your base plot. Everything else is optional, meaning you don’t need to use all eight layers. Additionally, layers 4-8 can be added in any order (more or less), whereas layers 1-3 must follow a fixed sequence.\n\n:::\n\n## Activity 1: Set-up and data for today\n\n* We are still working with the data from Pownall et al. (2023), so **open your project**.\n* However, let’s start with a fresh R Markdown file: **Create a new `.Rmd` file** and save it in your project folder. Give it a meaningful name (e.g., \"chapter_04.Rmd\" or \"04_data_viz.Rmd\"). If you need guidance, refer to @sec-rmd. Delete everything below line 12, but keep the setup code chunk.\n* We previously aggregated the data in @sec-wrangling and @sec-wrangling2. If you want a fresh copy, download the data here: [data_prp_for_ch4.csv](data/data_prp_for_ch4.csv \"download\"). Make sure to place the csv file in the project folder.\n* If you need a reminder about the data and variables, check the codebook or refer back to @sec-download_data_ch1.\n\n\n\n## Activity 2: Load in libraries, read in data, and adjust data types\n\nToday, we will be using the `tidyverse` package and the dataset `data_prp_for_ch4.csv`.\n\n```{r eval=FALSE}\n## packages \n???\n\n## data\ndata_prp_viz <- read_csv(???)\n```\n\n::: {.callout-caution collapse=\"true\" icon=\"false\"}\n\n## Solution\n\n```{r eval=FALSE}\nlibrary(tidyverse)\ndata_prp_viz <- read_csv(\"data_prp_for_ch4.csv\")\n```\n\n:::\n\n\n```{r include=FALSE}\n## I basically have to have 2 code chunks since I tell them to put the data files next to the project, and mine are in a separate folder called data - unless I'll turn this into a fixed path\n\nlibrary(tidyverse)\ndata_prp_viz <- read_csv(\"data/data_prp_for_ch4.csv\")\n```\n\n\n\nAs mentioned in @sec-familiarise, it is always a good idea to take a glimpse at the data to see how many variables and observations are in the dataset, as well as the data types.\n\n::: {.callout-note collapse=\"true\" icon=\"false\"}\n\n## glimpse output\n\n```{r}\nglimpse(data_prp_viz)\n```\n\n:::\n\n\nWe can see that some of the categorical data in `data_prp_viz` was read in as numeric variables which makes them continuous. This will haunt us big time when building the plots. We would be better off addressing these changes in the dataset before we start plotting (and potentially getting frustrated with R and data viz in general).\n\nLet’s convert some of the categorical variables into factors. We’ll use the `factor()` function, which requires the `variable` to convert, the `levels` (where we can re-order them as needed), and the corresponding `labels`.\n\n\n```{r}\ndata_prp_viz <- data_prp_viz %>% \n  mutate(Gender = factor(Gender,\n                         levels = c(2, 1, 3),\n                         labels = c(\"females\", \"males\", \"non-binary\")),\n         Secondyeargrade = factor(Secondyeargrade,\n                                  levels = c(1, 2, 3, 4, 5),\n                                  labels = c(\"≥ 70% (1st class grade)\", \"60-69% (2:1 grade)\", \"50-59% (2:2 grade)\", \"40-49% (3rd class)\", \"< 40%\")),\n         Plan_prereg = factor(Plan_prereg,\n                              levels = c(1, 3, 2),\n                              labels = c(\"Yes\", \"Unsure\", \"No\")),\n         Closely_follow = factor(Closely_follow,\n                                 levels = c(2, 3),\n                                 labels = c(\"Followed it somewhat\", \"Followed it exactly\")),\n         Research_exp = factor(Research_exp),\n         Pre_reg_group = factor(Pre_reg_group))\n\n```\n\n\n\n## Activity 3: Barchart (`geom_bar()`)\n\nA barchart is the best choice when you want to plot a single categorical variable.\n\nFor example, let’s say we want to count some demographic data, such as gender. To visualise the gender counts, we would use a **barplot**. This is done with `geom_bar()` in the third layer. Since the counting is done automatically in the background, the `aes()` function only requires an x value (i.e., the name of your variable).\n\n\n```{r fig-bc-base, fig.cap=\"Default barchart\"}\nggplot(data_prp_viz, aes(x = Gender)) +\n  geom_bar() \n```\n\n\nThis is the base plot done. You can customise it by adding different layers. For example, the **labels** could be clearer, or you might want to add a splash **colour**. Click on the tabs below to see examples of additional customisations, and try applying them to your base plot in your own `.Rmd` file.\n\n\n\n::: {.panel-tabset}\n\n## Colour\n\nWe can change the colour by adding a `fill` argument in the `aes()`. If we want to modify these colours further, we would add a `scale_fill_?` argument. If you have specific colours in mind, you would use `scale_fill_manual()`, or if you prefer to stick with pre-defined options like viridis, you can use `scale_fill_viridis_d()`.\n\n\n```{r}\nggplot(data_prp_viz, aes(x = Gender, fill = Gender)) +\n  geom_bar() +\n  # customise colour\n  scale_fill_viridis_d()\n```\n\n## Axes labels & margins\n\nThe x-axis label is fine, but the categories need to be relabelled. You can achieve this with the `scale_x_discrete()` function and the `labels =` argument. Just make sure to order the labels according to the order in the dataframe.\n\nThere is also a gap between the bottom of the chart and the bars that looks a bit odd. You can remove it by using the `expansion()` function.\n\n\n```{r}\nggplot(data_prp_viz, aes(x = Gender, fill = Gender)) +\n  geom_bar() +\n  scale_fill_viridis_d() +\n  # changing group labels on the breaks of the x axis\n  scale_x_discrete(labels = c(\"Female\", \"Male\", \"Non-Binary\")) + \n  scale_y_continuous(\n    # changing name of the y axis\n    name = \"Count\",\n    # remove the space below the bars (first number), but keep a tiny bit (5%) above (second number)\n    expand = expansion(mult = c(0, 0.05))\n  )\n  \n```\n\n## Legend\n\nThe legend does not add any useful information because the labels are already provided on the x-axis. We can remove the legend by adding the argument `guide = \"none\"` to the `scale_fill` function.\n\n\n```{r}\nggplot(data_prp_viz, aes(x = Gender, fill = Gender)) +\n  geom_bar() +\n  scale_fill_viridis_d(\n    # remove the legend\n    guide = \"none\") +\n  scale_x_discrete(labels = c(\"Female\", \"Male\", \"Non-Binary\")) +\n  scale_y_continuous(\n    name = \"Count\",\n    expand = expansion(mult = c(0, 0.05))\n  )\n  \n```\n\n## Themes\n\nLet's experiment with the themes. For this plot we have chosen `theme_minimal()`.\n\n\n```{r}\nggplot(data_prp_viz, aes(x = Gender, fill = Gender)) +\n  geom_bar() +\n  scale_fill_viridis_d(\n    guide = \"none\") +\n  scale_x_discrete(labels = c(\"Female\", \"Male\", \"Non-Binary\")) +\n  scale_y_continuous(\n    name = \"Count\",\n    expand = expansion(mult = c(0, 0.05))\n  ) +\n  # pick a theme\n  theme_minimal()\n  \n```\n:::\n\n## Activity 4: Column plot (`geom_col()`)\n\nIf the counts had already been summarised for you, `geom_bar()` would not work. Instead, you’d need to use `geom_col()` to display the pre-aggregated data.\n\n\n```{r}\ngender_count <- data_prp_viz %>% \n  count(Gender)\n\ngender_count\n```\n\nThe mapping for `geom_col()` requires both **x** and **y** aesthetics. In this example, **x** would represent the categorical variable (e.g., `Gender`), while **y** would refer to the column storing the summarised values (e.g., `n`). Notice how the axis title now reflects `n` instead of `count` in the base version.\n\n\n```{r fig-col, fig.cap=\"Column plot with different coloured bars\"}\nggplot(gender_count, aes(x = Gender, y = n, fill = Gender)) +\n  geom_col()\n```\n\n\n::: {.callout-note icon=\"false\"}\n\n\n## Your Turn: Make the column plot pretty\n\nThe other layers to change the colour scheme, axes labels and margins, removing the legend and altering the theme require exactly the same functions as with the boxplot above. Test yourself to see if you can...\n\n* [ ] change the colour scheme (e.g., viridis or [any other colour palettes](https://www.datanovia.com/en/blog/the-a-z-of-rcolorbrewer-palette/){target=\"_blank\"})\n* [ ] remove the legend\n* [ ] change the titles of the x and y axes\n* [ ] make the bars start directly on the x-axis\n* [ ] add a theme of your liking\n\n\n\n::: {.callout-tip collapse=\"true\"}\n\n## Possible solution code for the column plot (with a different colour palette and a different theme)\n\n```{r}\nggplot(gender_count, aes(x = Gender, y = n, fill = Gender)) +\n  geom_col() +\n  # replaced vidiris with the brewer palette\n  scale_fill_brewer(\n    palette = \"Set1\", # try \"Set2\" or \"Dark2\" for some variety\n    guide = \"none\") + # legend removed\n  # labels of the categories changed\n  scale_x_discrete(labels = c(\"Male\", \"Female\", \"Non-Binary\")) + \n  scale_y_continuous(\n    # change y axis label\n    name = \"Count\",\n    # starts bars on x axis without any gaps but leaves some space at the top (this time 10%)\n    expand = expansion(mult = c(0, 0.1)) \n  ) +\n  # different theme\n  theme_light()\n```\n\n:::\n\n:::\n\n\n## Activity 5: Stacked, Percent Stacked, and Grouped Barchart {#sec-adv_bar}\n\nWhen dealing with **two categorical variables**, you have three options for displaying stacked barcharts: the \"normal\" **Stacked Barchart** (the default option), a **Percent Stacked Barchart**, or a **Grouped Barchart**.\n\nFor this activity, we will explore the variable `Plan_prereg`, which measures whether students planned to pre-register their undergraduate dissertation at time point 1, and `Pre_reg_group`, which tracks whether they actually followed through with a pre-registration for their dissertation.\n\nOne way to display this data is by creating either a **Stacked Barchart** (the default) or a **Percent Stacked Barchart**. In both cases, the subgroups are displayed on top of each other. To make comparison easier, we will place the two plots side by side and move the legend to the bottom of the chart.\n\n\n\n```{r, eval=FALSE}\n## Stacked barchart\nggplot(data_prp_viz, aes(x = Plan_prereg, fill = Pre_reg_group)) +\n  geom_bar() + # no position argument added\n  theme(legend.position = \"bottom\") # move legend to the bottom\n\n## Percent stacked barchart\nggplot(data_prp_viz, aes(x = Plan_prereg, fill = Pre_reg_group)) +\n  geom_bar(position = \"fill\") + # add position argument here\n  theme(legend.position = \"bottom\") # move legend to the bottom\n```\n\n```{r, fig-barcharts_stacked, fig.cap=\"Stacked barchart (left), and Percent stacked barchart (right)\", echo=FALSE}\n## Stacked barchart\nbc_stacked <- ggplot(data_prp_viz, aes(x = Plan_prereg, fill = Pre_reg_group)) +\n  geom_bar() + # add position argument here\n  theme(legend.position = \"bottom\") + # move legend to the bottom\n  guides(fill = guide_legend(nrow = 1)) # display across 2 rows\n\n## Percent stacked barchart\nbc_percent <- ggplot(data_prp_viz, aes(x = Plan_prereg, fill = Pre_reg_group)) +\n  geom_bar(position = \"fill\") + # add position argument here\n  theme(legend.position = \"bottom\") + # move legend to the bottom\n  guides(fill = guide_legend(nrow = 1)) # display across 2 rows\n\nbc_stacked + bc_percent + plot_layout(nrow = 1)\n```\n\n\nIn the **stacked barchart** (@fig-barcharts_stacked, left plot), you can display participant numbers. From this, we can see that the highest number of students were unsure whether they wanted to pre-register their dissertation, followed closely by those who answered \"yes.\" We also see that the number of students who did not end up with a pre-registered dissertation (blue category) is the same for both those who had planned to pre-register and those who did not want to. However, since the \"No\" category has significantly fewer participants than the other two, it’s difficult to tell if the ratio remains consistent across all three groups.\n\nIf we want to highlight this ratio, a **Percent Stacked Barchart** (@fig-barcharts_stacked, right plot) would be more appropriate. This plot shows that approximately 80% of the students who had planned to pre-register their dissertations, 50% of the students who were initially unsure, and only 33% of the students who had no plan to pre-register ended up with a pre-registered dissertation. BUT! We would lose the information about the raw values in the sample.\n\n**It’s all a trade-off, and the plot you choose depends on the \"story\" you want the data to tell.**\n\n\n::: callout-note\n\nThe position argument `position = \"stack\"` is the default. Adding this argument to the code for the left plot in @fig-barcharts_stacked would produce the same plot as leaving the argument out.\n\n\n:::\n\n\nThe other option is a **Grouped Barchart**, which displays the bars next to each other. You can achieve this by changing the `position` argument to `\"dodge\"`. You can see the default version of the plot in @fig-barchart_grouped on the left, and one with additional layers on the right.\n\nInstead of using a pre-existing colour palette, we manually changed the colours using hex codes. These are some of the colours Gaby used in her PhD thesis, but you can:\n\n* create your own colour hex codes by using [this website](https://www.hexcolortool.com/){target=\"_blank\"}, OR\n* use pre-defined colour names like \"green\" or \"purple\" instead. See a full list [here](https://www.datanovia.com/en/blog/awesome-list-of-657-r-color-names/){target=\"_blank\"}.\n\nFeel free to explore.\n\nSince the legend title for the second plot is a bit long, we displayed the legend content across two rows by adding the layer `guides(fill = guide_legend(nrow = 2))` at the end.\n\n\n\n```{r eval=FALSE}\n## Default grouped barchart\nggplot(data_prp_viz, aes(x = Plan_prereg, fill = Pre_reg_group)) +\n  geom_bar(position = \"dodge\") + # add position argument here\n  theme(legend.position = \"bottom\") # move legend to the bottom\n\n## Prettier grouped barchart\nggplot(data_prp_viz, aes(x = Plan_prereg, fill = Pre_reg_group)) +\n  geom_bar(position = \"dodge\") + # add position argument here\n  # changing labels for x, y, and fill category - alternative method\n  labs(x = \"Pre-registration planned\", y = \"Count\", fill = \"Pre-registered dissertation\") +\n  # manual colour change for values\n  scale_fill_manual(values = c('#648FFF', '#DC267F'),\n                    labels = c(\"Yes\", \"No\")) +\n  scale_y_continuous(\n    # remove the space below the bars, but keep a tiny bit (5%) above\n    expand = expansion(mult = c(0, 0.05))\n  ) +\n  # pick a theme\n  theme_classic() + \n  # need to move this following line to the end otherwise the `theme_*` overrides it\n  theme(legend.position = \"bottom\") + \n  # display across 2 rows\n  guides(fill = guide_legend(nrow = 2))\n  \n```\n\n```{r fig-barchart_grouped, fig.cap=\"Default grouped barchart (left) and one with a few more layers added (right)\", echo=FALSE}\ngbc_default <- ggplot(data_prp_viz, aes(x = Plan_prereg, fill = Pre_reg_group)) +\n  geom_bar(position = \"dodge\") + # add position argument here\n  theme(legend.position = \"bottom\") # move legend to the bottom\n\n## Prettier grouped barchart\ngbc_pretty <- ggplot(data_prp_viz, aes(x = Plan_prereg, fill = Pre_reg_group)) +\n  geom_bar(position = \"dodge\") + # add position argument here\n  # changing labels for x, y, and fill category - alternative method\n  labs(x = \"Pre-registration planned\", y = \"Count\", fill = \"Pre-registered dissertation\") +\n  # manual colour change for values\n  scale_fill_manual(values = c('#648FFF', '#DC267F'),\n                    labels = c(\"Yes\", \"No\")) +\n  scale_y_continuous(\n    # remove the space below the bars, but keep a tiny bit (5%) above\n    expand = expansion(mult = c(0, 0.05))\n  ) +\n  # pick a theme\n  theme_classic() + \n  # need to move this following line to the end otherwise the `theme_*` overrides it\n  theme(legend.position = \"bottom\") + \n  # display across 2 rows\n  guides(fill = guide_legend(nrow = 2)) \n\ngbc_default + gbc_pretty + plot_layout(nrow = 1)  \n```\n\n\n::: {.callout-tip collapse=\"true\" icon=\"false\"}\n\n## Special case: Categorical variables with missing values\n\nIf we had chosen a different categorical variable that contains missing values, such as `Closely_follow`, our plots would have included those missing values by default. To change the colour of the missing value bars, you would need to specify this using the `na.value =` argument within the `scale_fill()` function. Here’s an example of a grouped barchart.\n\n\n\n```{r eval=FALSE}\n# default grouped barchart with missing values\nggplot(data_prp_viz, aes(x = Plan_prereg, fill = Closely_follow)) +\n  geom_bar(position = \"dodge\") + \n  theme(legend.position = \"bottom\") + \n  guides(fill = guide_legend(nrow = 3)) # display across 3 rows\n\n## Prettier grouped barchart with missing values\nggplot(data_prp_viz, aes(x = Plan_prereg, fill = Closely_follow)) +\n  geom_bar(position = \"dodge\") + \n  labs(x = \"Pre-registration planned\", y = \"Count\", fill = \"Pre-registration followed\") +\n  # manual colour change for values of the factor and the NA responses\n  scale_fill_manual(values = c('#648FFF', '#DC267F'), na.value = '#FFB000') +\n  scale_y_continuous(\n    expand = expansion(mult = c(0, 0.05))\n  ) +\n  theme_classic() + \n  theme(legend.position = \"bottom\") + \n  guides(fill = guide_legend(nrow = 3)) # display across 3 rows\n```\n\n```{r fig-barchart_grouped_na, fig.cap=\"Default grouped barchart (left) and one with a few more layers added (right) for a variable with missing values\", echo=FALSE}\ngbc_default <- ggplot(data_prp_viz, aes(x = Plan_prereg, fill = Closely_follow)) +\n  geom_bar(position = \"dodge\") + \n  theme(legend.position = \"bottom\") + \n  guides(fill = guide_legend(nrow = 3)) # display across 3 rows\n\n## Prettier grouped barchart with missing values\ngbc_pretty <- ggplot(data_prp_viz, aes(x = Plan_prereg, fill = Closely_follow)) +\n  geom_bar(position = \"dodge\") + \n  labs(x = \"Pre-registration planned\", y = \"Count\", fill = \"Pre-registration followed\") +\n  # manual colour change for values of the factor and the NA responses\n  scale_fill_manual(values = c('#648FFF', '#DC267F'), na.value = '#FFB000') +\n  scale_y_continuous(\n    expand = expansion(mult = c(0, 0.05))\n  ) +\n  theme_classic() + \n  theme(legend.position = \"bottom\") + \n  guides(fill = guide_legend(nrow = 3)) # display across 3 rows\n\ngbc_default + gbc_pretty + plot_layout(nrow = 1)  \n```\n\n\nIf you don’t want the missing values to appear in the plot, you will need to do some data wrangling to remove them first. The function for this is `drop_na()`. Here we applied `drop_na()` to `Closely_follow` only.\n\n\n```{r}\n# remove NA\nprereg_plan_follow <- data_prp_viz %>% \n  select(Code, Plan_prereg, Closely_follow) %>% \n  drop_na(Closely_follow)\n```\n\n\n::: {.callout-note collapse=\"true\" icon=\"false\"}\n\n## check NAs have been removed\n\n```{r}\n# check NA have been removed\nprereg_plan_follow %>% \n  distinct(Plan_prereg, Closely_follow) %>% \n  arrange(Plan_prereg, Closely_follow)\n```\n\n:::\n\nBut keep in mind that it could misrepresent the data, e.g., giving a wrong impression about proportions. As a comparison...\n\n\n```{r eval=FALSE}\n# with NA\nggplot(data_prp_viz, aes(x = Plan_prereg, fill = Closely_follow)) +\n  geom_bar(position = \"fill\") + # add position argument here\n  theme(legend.position = \"bottom\") + # move legend to the bottom\n  guides(fill = guide_legend(nrow = 2)) # display across 2 rows\n\n# without NA\nggplot(prereg_plan_follow, aes(x = Plan_prereg, fill = Closely_follow)) +\n  geom_bar(position = \"fill\") + # add position argument here\n  theme(legend.position = \"bottom\") + # move legend to the bottom\n  guides(fill = guide_legend(nrow = 2)) # display across 2 rows\n```\n\n```{r fig-barchart_na_no_na, echo=FALSE, fig.cap=\"Percent stacked barchart with (left) and without missing values (right)\"}\n# with NA\ncomp_a <- ggplot(data_prp_viz, aes(x = Plan_prereg, fill = Closely_follow)) +\n  geom_bar(position = \"fill\") + # add position argument here\n  theme(legend.position = \"bottom\") + # move legend to the bottom\n  guides(fill = guide_legend(nrow = 2)) # display across 2 rows\n\n# without NA\ncomp_b <- ggplot(prereg_plan_follow, aes(x = Plan_prereg, fill = Closely_follow)) +\n  geom_bar(position = \"fill\") + # add position argument here\n  theme(legend.position = \"bottom\") + # move legend to the bottom\n  guides(fill = guide_legend(nrow = 2)) # display across 2 rows\n\ncomp_a + comp_b + plot_layout(nrow = 1)\n```\n\n:::\n\n\n## Activity 6: Save your plots\n\nYou can save your figures using the `ggsave()` function, which will save them to your project folder.\n\nThere are two ways to use `ggsave()`. If you don’t specify which plot to save, by **default** it will **save the last plot you created**. In our case, the last plot was the one without `NA` from the special case scenario (@fig-barchart_na_no_na). However, if you did not follow along with the special case scenario, your last plot will be the grouped bar chart on the right from @fig-barchart_grouped.\n\n\n\n```{r eval=FALSE}\nggsave(filename = \"last_plot.png\")\n```\n\n```{r include=FALSE}\ncomp_b\nggsave(filename = \"images/last_plot.png\")\n```\n\n::: {.callout-note collapse=\"true\" icon=\"false\"}\n\n## Our last plot saved\n\n![](images/last_plot.png)\n:::\n\n\nThe second option is to save the plot as an object and refer to the object within `ggsave()`. As an example, let's save the grouped barchart that contained missing values (@fig-barchart_grouped) as an object called `grouped_bar`.\n\nThe second option is to save the plot as an object and then refer to that object within `ggsave()`. For example, let’s save the grouped barchart that contained missing values (@fig-barchart_grouped) as an object called `grouped_bar`.\n\n\n```{r}\ngrouped_bar <- ggplot(data_prp_viz, aes(x = Plan_prereg, fill = Closely_follow)) +\n  geom_bar(position = \"dodge\") + \n  labs(x = \"Pre-registration planned\", y = \"Count\", fill = \"Pre-registration followed\") +\n  # manual colour change for values of the factor and the NA responses\n  scale_fill_manual(values = c('#648FFF', '#DC267F'), na.value = '#FFB000') +\n  scale_y_continuous(\n    expand = expansion(mult = c(0, 0.05))\n  ) +\n  theme_classic() + \n  theme(legend.position = \"bottom\") + \n  guides(fill = guide_legend(nrow = 3)) # display across 3 rows\n```\n\nThen, you can run the following line:\n\n```{r eval=FALSE}\nggsave(filename = \"grouped_bar.png\", \n       plot = grouped_bar)\n```\n\n```{r echo=FALSE}\nggsave(filename = \"images/grouped_bar.png\", \n       plot = grouped_bar)\n```\n\nThe `filename` is the name you want your PNG file to have, and `plot` refers to the name of the plot object.\n\n\n::: {.callout-note collapse=\"true\" icon=\"false\"}\n\n## Our saved `grouped_bar.png` would look like this:\n\n![](images/grouped_bar.png)\n:::\n\nThis is the plot saved with the default settings. If you like it, feel free to keep it as is. However, if it seems a bit \"off\", you can adjust the width, height, and units (e.g., \"cm\", \"mm\", \"in\", \"px\"). You might need to experiment with the dimensions until it feels about right.\n\n\n```{r eval=FALSE}\nggsave(filename = \"grouped_bar2.png\", \n       plot = grouped_bar, \n       width = 16, height = 9, units = \"cm\")\n```\n\n```{r echo=FALSE}\nggsave(filename = \"images/grouped_bar2.png\", \n       plot = grouped_bar, \n       width = 16, height = 9, units = \"cm\")\n```\n\n::: {.callout-note collapse=\"true\" icon=\"false\"}\n\n## `grouped_bar.png` with different dimensions\n\n![](images/grouped_bar2.png)\n:::\n\n\n\n## [Test your knowledge]{style=\"color: #F39C12; text-transform: uppercase;\"} {.unnumbered}\n\nLet's go back to the `palmerpenguins` package ([https://allisonhorst.github.io/palmerpenguins/](https://allisonhorst.github.io/palmerpenguins/){target=\"_blank\"}), and assume you have the following data available:\n\n\n```{r message=FALSE}\nlibrary(palmerpenguins)\n\npenguin_selection <- penguins %>% \n  group_by(species, island) %>% \n  summarise(penguin_count = n())\n\npenguin_selection\n```\n\n\n\n### Knowledge check {.unnumbered}\n\n#### Question 1 {.unnumbered}\n\nWhat `geom` would you use to plot penguin count for each species? `r mcq(c(x = \"geom_bar\", answer = \"geom_col\"))`\n\n\n#### Question 2 {.unnumbered}\n\nWhat mapping would you use to display penguin count across species? `r longmcq(c(x = \"aes(x = penguin_count, y = species)\", answer = \"aes(x = species, y = penguin_count)\", x = \"aes(x = species)\", x = \"aes(x = penguin_count)\"))`\n\n\n#### Question 3 {.unnumbered}\n\nWhat `geom` would you use to count the number of species on each island? `r mcq(c(answer = \"geom_bar\", x = \"geom_col\"))`\n\n\n#### Question 4 {.unnumbered}\n\nWhat mapping would you use to display the count of species per island? `r longmcq(c(x = \"aes(x = island, y = species)\", x = \"aes(x = species, y = island)\", answer = \"aes(x = island)\", x = \"aes(x = species)\"))`\n\n\n::: {.callout-caution collapse=\"true\" icon=\"false\"}\n\n## Explain these answers\n\n**Question 1**: `geom_col()` is the appropriate choice for bar charts with predefined y-values, such as `penguin_count`.\n\n**Question 2**: The correct aesthetic mapping places the categorical variable (`species`) on the x-axis and the numeric variable (number of observed penguins) on the y-axis. Using `aes(x = penguin_count, y = species)` would flip the axes, placing the number of penguins on the x-axis and species on the y-axis, which doesn’t match the conventional structure of a bar chart.\n\n**Question 3**: `geom_bar()` is the appropriate choice when you want to automatically count the number of observations within each category, such as counting the number of penguin species on each island.\n\n**Question 4**: For a simple count of species per island, you only need to map the categorical variable (`island`) to the x-axis. The y-axis will automatically represent counts when using `geom_bar()`.\n\n:::\n\n\n\n### Error mode {.unnumbered}\n\nSome of the code chunks contain mistakes and result in errors, while others do not produce the expected results. Your task is to identify any issues, explain why they occurred, and, if possible, fix them.\n\n\n#### Question 5 {.unnumbered}\n\nWe want to plot the number of penguins across the different islands.\n\n```{r error=TRUE}\nggplot(penguins, aes(x = islands)) +\n  geom_bar()\n```\n\nWhat does this error message mean and how do you fix it?\n\n::: {.callout-caution collapse=\"true\" icon=\"false\"}\n\n## Explain the solution\n\nThe error message consists of 2 parts. Part 1 is perhaps a bit trickier to interpret, but part 2 gives some useful hints:\n\n* *\"Aesthetics must be either length 1 or the same as the data (344)\"*: This means that the variable mapped to `x` should either be a constant (like a single value) or a column that has 344 entries (matching the number of rows in the penguins dataset).\n* *\"Fix the following mappings: `x`\"*: The issue is specifically with the `x` aesthetic, meaning `islands` is either misspelled or doesn’t exist in the dataset.\n\nTo check the `penguins` data, you can use `glimpse()`.\n\n```{r}\nglimpse(penguins)\n```\n\n\nTo fix the error, you need to correct the column name. The correct column in the `penguins` dataset is called `island` (without the \"s\" at the end). The `island` column has 344 entries, just like the rest of the dataset, so the mapping now works properly.\n\n```{r}\nggplot(penguins, aes(x = island)) +\n  geom_bar()\n```\n\n:::\n\n\n#### Question 6 {.unnumbered}\n\nNext, we want to create a grouped bar chart displaying species per island, using the viridis color palette.\n\n```{r error=TRUE}\nggplot(penguins, aes(x = island, fill = species)) +\n  geom_bar(position = \"dodge\") +\n  scale_fill_viridis()\n```\n\nWhat does this error message mean and how do you fix it?\n\n::: {.callout-caution collapse=\"true\" icon=\"false\"}\n\n## Explain the solution\n\nThe function `scale_fill_viridis()` is incorrect; the correct function is called `scale_fill_viridis_d()`.\n\nFIX: correct the function name to display the grouped bar chart with the viridis color palette.\n\n```{r}\nggplot(penguins, aes(x = island, fill = species)) +\n  geom_bar(position = \"dodge\") +\n  scale_fill_viridis_d()\n```\n\n:::\n\n\n\n#### Question 7 {.unnumbered}\n\nWe want to create a grouped bar chart showing the number of penguins on each island, broken down by year.\n\n```{r error=TRUE}\nggplot(penguins, aes(x = island, fill = year)) +\n  geom_bar(position = \"dodge\")\n```\n\nHmmm. We got a plot, but certainly not the one we intended. The warning message mentions something about the grouping structure and gives some additional hints.\n\n::: {.callout-caution collapse=\"true\" icon=\"false\"}\n\n## Explain the solution\n\nThe grouping variable needs to be a factor. R helpfully asks if we’ve forgotten to convert a numerical variable into a factor!!! Oh, let's check that in the `penguins` data using the `glimpse()` function.\n\n\n```{r}\nglimpse(penguins)\n```\n\nIndeed, `year` is currently stored as a numeric (integer) variable. To fix this, we need to convert `year` to a factor. We can do this directly within the `ggplot()` function.\n\n```{r}\nggplot(penguins, aes(x = island, fill = as.factor(year))) +\n  geom_bar(position = \"dodge\")\n```\n\n:::\n\n\n\n\n#### Question 8 {.unnumbered}\n\nWe want to create a percent stacked bar chart that displays the ratio of penguins' sex on each island, using a manual color palette. Female penguins should be displayed in blue, males in green, and `NA` values in red.\n\n**Note**: This task is trickier than it looks. Although the code runs and produces a plot, there are three mistakes to identify and fix.\n\n```{r error=TRUE}\nggplot(penguins, aes(x = sex, fill = island)) +\n  geom_bar(position = \"dodge\") +\n  scale_fill_manual(values = c(\"blue\", \"green\", \"red\"))\n```\n\n::: {.callout-caution collapse=\"true\" icon=\"false\"}\n\n## Explain the solution\n\n::: {.callout-note collapse=\"true\" icon=\"false\"}\n\n## Hint for Mistake 1\n\nThe task was to create a **percent stacked barchart**, but the current plot is displaying a grouped barchart. You will need to adjust the argument that defines the type of plot to achieve the correct visualisation.\n\n::: {.callout-caution collapse=\"true\" icon=\"false\"}\n\n## Fixing of Mistake 1\n\n```{r}\nggplot(penguins, aes(x = sex, fill = island)) +\n  geom_bar(position = \"fill\") +\n  scale_fill_manual(values = c(\"blue\", \"green\", \"red\"))\n```\n\n:::\n\n:::\n\n::: {.callout-note collapse=\"true\" icon=\"false\"}\n\n## Hint for Mistake 2\n\nYou may have also noticed that the colours are mapped to the islands, not to the penguins' sex, which needs to be corrected.\n\n::: {.callout-caution collapse=\"true\" icon=\"false\"}\n\n## Fixing of Mistake 2\n\nWe need to switch the columns mapped to the `x` and `fill` aesthetics.\n\n```{r}\nggplot(penguins, aes(x = island, fill = sex)) +\n  geom_bar(position = \"fill\") +\n  scale_fill_manual(values = c(\"blue\", \"green\", \"red\"))\n```\n\n\n:::\n\n:::\n\n::: {.callout-note collapse=\"true\" icon=\"false\"}\n\n## Hint for Mistake 3\n\nNow that the correct variables are mapped to the x-axis and the fill argument, the colour scheme no longer matches the instructions. According to the guidelines, missing values should be displayed in red.\n\n::: {.callout-caution collapse=\"true\" icon=\"false\"}\n\n## Fixing of Mistake 3\n\nChanging the colour of missing values is a special case that requires the argument `na.value =`.\n\n```{r}\nggplot(penguins, aes(x = island, fill = sex)) +\n  geom_bar(position = \"fill\") +\n  scale_fill_manual(values = c(\"blue\", \"green\"), na.value = \"red\")\n```\n\n:::\n\n:::\n\n:::\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"kable","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":false,"code-overflow":"wrap","code-link":true,"code-line-numbers":true,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["https://use.fontawesome.com/releases/v5.13.0/css/all.css","include/booktem.css","include/webex.css","include/glossary.css","include/style.css","include/custom.scss","include/styles.css"],"highlight-style":"a11y","include-after-body":["include/webex.js","include/script.js"],"output-file":"04-dataviz.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.5.57","lightbox":true,"bibliography":["include/references.bib"],"csl":"include/apa.csl","theme":{"light":["flatly","include/light.scss"],"dark":["darkly","include/dark.scss"]},"code-copy":"hover","mainfont":"","monofont":""},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}